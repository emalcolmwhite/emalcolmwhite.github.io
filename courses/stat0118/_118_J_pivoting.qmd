---
title: 'reshaping data with `tidyr`'
author: 'Emily Malcolm-White'
format:
  html: 
    toc: TRUE
    code-overflow: wrap
    embed-resources: true
    code-tools:
      source: true
      toggle: false
      caption: none
    code-annotations: hover
execute: 
  message: FALSE
  warning: FALSE
---


![](https://tidyr.tidyverse.org/logo.png){width=30%}

The goal of `tidyr` is to help you create tidy data. 

![Illustrations from the Openscapes blog Tidy Data for reproducibility, efficiency, and collaboration by Julia Lowndes and Allison Horst](https://cdn.myportfolio.com/45214904-6a61-4e23-98d6-b140f8654a40/85520b8f-4629-4763-8a2a-9ceff27458bf_rw_1920.jpg?h=21007b20ac00cf37318dca645c215453)


![https://r4ds.hadley.nz/data-tidy](https://r4ds.hadley.nz/images/tidy-1.png)

# Today's dataset: `portal` 

The Portal Project dataset comes from a long-term ecological study that began in 1977 near Portal, Arizona, USA. Researchers have been collecting data continuously for nearly 50 years, making it one of the longest-running ecological studies in the world.

```{r}
#LOAD PACKAGES
library(tidyverse)

#LOAD DATA
portal_rodent <- read.csv("https://github.com/weecology/PortalData/raw/main/Rodents/Portal_rodent.csv")
```


```{r}
# SOME SUMMARY STATS
portal_wgt_summary <- portal_rodent %>%
  filter(!is.na(wgt)) %>%
  group_by(plot, species) %>%
  summarize(mean_wgt = mean(wgt))

portal_wgt_summary
```

# Pivot Wider with `portal`

![](https://datacarpentry.org/R-ecology-lesson/fig/pivot_wider_graphic.png)

![](https://datacarpentry.org/R-ecology-lesson/fig/tidyr-pivot_wider_longer.gif)

**`pivot_wider()` reduces the number of rows and increases the number of columns.**

Practicing transforming this data from long to wide format: 

```{r}

```

`pivot_wider()` is helpful when:

- You have key-value pairs (e.g., variable names and values) that you want to turn into actual columns.
- You want to summarize or compare values side-by-side across categories or time periods.
- You’re preparing data for modeling or presentation where wide format is more natural.


# Pivot Longer

`pivot_longer()` is helpful when:

- You have multiple columns representing the same kind of data (e.g., test scores, years, conditions) and you want to gather them into key-value pairs.

![](https://datacarpentry.org/R-ecology-lesson/fig/pivot_longer_graphic.png)

**`pivot_longer()` reduces the number of columns and increases the number of rows**

Practicing transforming this data from wide to long format: 

```{r}

```


# Common Pitfalls

## Missing Combinations in `pivot_wider()`

```{r}
example <- tibble(
  species_id = c("DM", "DM", "DO"),
  month = c("jan", "feb", "jan"),
  avg_weight = c(40, 38, 31)
)

example
```

```{r}
example %>% 
  pivot_wider(
    names_from = month,
    values_from = avg_weight
  )
```

Fix: Use `values_fill` to replace missing values with 0 (or another placeholder)

##  Duplicate combinations in `pivot_wider()`

```{r}
example <- tibble(
  species_id = c("DM", "DM", "DO"),
  month = c("jan", "jan", "jan"),
  avg_weight = c(40, 42, 31)
)

example
```

```{r}
example %>% 
  pivot_wider(
    names_from = month,
    values_from = avg_weight
  )
```
Fix: Tell R how to combine duplicates — for example, by taking the mean: `values_fn = mean`

## Column names encode multiple variables in `pivot_longer()`

```{r}
example <- tibble(
  species_id = c("DM", "DO"),
  weight_male = c(40, 32),
  weight_female = c(38, 31)
)

example
```

```{r}
```


```{r}
example %>% 
  pivot_longer(
    cols = starts_with("weight"), ## CHECK THIS OUT!
    names_to = "sex",
    values_to = "weight"
  )
```
Fix: 

```{r}
example %>% 
  pivot_longer(
    cols = starts_with("weight"),
    names_to = c(".value", "sex"),
    names_sep = "_"
  )
```


# Challenge

Reshape the rodents data frame with year as columns, plot as rows, and the number of species per plot as the values. You will need to summarize before reshaping, and use the function `n_distinct()` to get the number of unique species within a particular chunk of data. It’s a powerful function! See ?n_distinct for more.

```{r}

```
